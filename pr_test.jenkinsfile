Map modules = [:]
pipeline {
  agent none
  environment {
    email_add1 = 'ivan.pilyushenko@weigandt-consulting.com'
    email_add2 = 'konstantin.orlov@weigandt-consulting.com'
  }
  /* DEV DEPLOYMENT STAGE */
  stages {
    stage('DEV Deploy') {
      agent {
        node {
          label "jenkins01"
        }
      }
      when {
        beforeAgent true
        allOf {
          anyOf{
            expression { params.PR_ACTION ==~ "opened" }
            expression { params.PR_ACTION ==~ "synchronize" }
          }         
          expression { params.BASE_BRANCH ==~ "develop" }
        }
      }
      environment {
        DEPLOY_ENV = 'DEV'
        HOSTNAME = sh(script: "hostname", returnStdout: true).trim()
        IP_ADDR = sh(script: "hostname -I | awk '{print \$1}'", returnStdout: true)
      }
      steps {
        /* Sending deployment initialization email */
        emailext (
              subject: "Starting deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment",
              mimeType: "text/html",
              from: "zabbix@weigandt-consulting.com",
              body: """<h4 style="font-family:tahoma;">The following <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub Pull Request</a> has initiated deployment:</h4>
              <ul style="font-family:tahoma;">
                <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
                <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
                <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
                <li>By user:        <b>${params.PR_USER}</b>;</li>
                <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
                <li>Hostname:       <b>${env.HOSTNAME}</li>
                <li>IP:       <b>${env.IP_ADDR}</li>
              </ul>
              <p style="font-family:tahoma;">Files scheduled for deployment can be found <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}/files">here</a>.</p>
              <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
              to: "${env.email_add1}, ${env.email_add2}"
        )
        script { 
          /*showGifDiff("${params.HEAD_SHA}", "${params.BASE_SHA}") */
          modules.showGitDiff = load "showGitDiff.groovy"
          modules.showGitDiff.showGitDiff("${params.HEAD_SHA}", "${params.BASE_SHA}")
        }
        /* main steps */
        echo "========================================"
        echo "deployment to ${env.DEPLOY_ENV} is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.HEAD_BRANCH}"
        /*withEnv(["DEPLOY_ENV=DEV"]) {
          echo "DEPLOY_ENV = ${env.DEPLOY_ENV}"
        }*/
        echo "Executing move_rpd.sh script"
        sh 'chmod +x ./move_rpd.sh'
        sh './move_rpd.sh'
      }
      post {
        success {
          emailext (
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment SUCCEEDED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(40,224,31)">SUCCESS</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
        failure {
          emailext (
            attachLog: true, 
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment FAILED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(247,32,9)">FAILURE</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
      }
    }
    /* TEST DEPLOYMENT STAGE */
    stage('TEST deploy') {
      agent {
        node {
          label 'spbdocker'
        }
      }
      when {
        beforeAgent true
        allOf {
          expression { params.BASE_BRANCH ==~ "develop" }
          expression { params.PR_ACTION ==~ "submitted" }
          expression { params.REVIEW_STATE ==~ "approved" }
        }
      }
      environment {
        DEPLOY_ENV = 'TEST'
        HOSTNAME = sh(script: "hostname", returnStdout: true).trim()
        IP_ADDR = sh(script: "hostname -I | awk '{print \$1}'", returnStdout: true)
      }
      steps {
        /* Sending deployment initialization email */
        emailext (
              subject: "Starting deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment",
              mimeType: "text/html",
              from: "zabbix@weigandt-consulting.com",
              body: """<h4 style="font-family:tahoma;">The following <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub Pull Request</a> has initiated deployment:</h4>
              <ul style="font-family:tahoma;">
                <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
                <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
                <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
                <li>By user:        <b>${params.PR_USER}</b>;</li>
                <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
                <li>Hostname:       <b>${env.HOSTNAME}</li>
                <li>IP:       <b>${env.IP_ADDR}</li>
              </ul>
              <p style="font-family:tahoma;">Files scheduled for deployment can be found <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}/files">here</a>.</p>
              <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
              to: "${env.email_add1}, ${env.email_add2}"
        )
        script { 
          /*showGifDiff("${params.HEAD_SHA}", "${params.BASE_SHA}") */
          modules.showGitDiff = load "showGitDiff.groovy"
          modules.showGitDiff.showGitDiff("${params.HEAD_SHA}", "${params.BASE_SHA}")
        }
        echo "========================================"
        echo "deployment to ${env.DEPLOY_ENV} is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.EAD_BRANCH}"
        echo "REVIEW_STATE value is ${params.REVIEW_STATE}"
        /*withEnv(["DEPLOY_ENV=DEV"]) {
          echo "DEPLOY_ENV = ${env.DEPLOY_ENV}"
        }*/
        echo "Executing move_rpd.sh script"
        sh 'chmod +x ./move_rpd.sh'
        sh './move_rpd.sh'
      }
      post {
        success {
          emailext (
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment SUCCEEDED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(40,224,31)">SUCCESS</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
        failure {
          emailext (
            attachLog: true, 
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment FAILED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(247,32,9)">FAILURE</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
      }
    }
    /* PROD DEPLOYMENT STAGE */
    stage('PROD deploy') {
      agent {
        node {
          label 'spbdocker'
        }
      }
      when {
        beforeAgent true
        allOf {
          expression { params.PR_ACTION ==~ "submitted" }
          expression { params.BASE_BRANCH ==~ "main" }
          expression { params.HEAD_BRANCH ==~ "develop" }
          expression { params.REVIEW_STATE ==~ "approved" }
        }
      }
      environment {
        DEPLOY_ENV = 'PROD'
        HOSTNAME = sh(script: "hostname", returnStdout: true).trim()
        IP_ADDR = sh(script: "hostname -I | awk '{print \$1}'", returnStdout: true)
      }
      steps {
        emailext (
              subject: "Starting deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment",
              mimeType: "text/html",
              from: "zabbix@weigandt-consulting.com",
              body: """<h4 style="font-family:tahoma;">The following <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub Pull Request</a> has initiated deployment:</h4>
              <ul style="font-family:tahoma;">
                <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
                <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
                <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
                <li>By user:        <b>${params.PR_USER}</b>;</li>
                <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
                <li>Hostname:       <b>${env.HOSTNAME}</li>
                <li>IP:       <b>${env.IP_ADDR}</li>
              </ul>
              <p style="font-family:tahoma;">Files scheduled for deployment can be found <a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}/files">here</a>.</p>
              <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
              to: "${env.email_add1}, ${env.email_add2}"
        )
        script { 
          /*showGifDiff("${params.HEAD_SHA}", "${params.BASE_SHA}") */
          modules.showGitDiff = load "showGitDiff.groovy"
          modules.showGitDiff.showGitDiff("${params.HEAD_SHA}", "${params.BASE_SHA}")
        }
        echo "========================================"
        echo "deployment to ${env.DEPLOY_ENV} is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.HEAD_BRANCH}"
        echo "REVIEW_STATE value is ${params.REVIEW_STATE}"
        /*withEnv(["DEPLOY_ENV=DEV"]) {
          echo "DEPLOY_ENV = ${env.DEPLOY_ENV}"
        }*/
        echo "Executing move_rpd.sh script"
        sh 'chmod +x ./move_rpd.sh'
        sh './move_rpd.sh'
      }
      post {
        success {
          emailext (
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment SUCCEEDED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(40,224,31)">SUCCESS</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
        failure {
          emailext (
            attachLog: true, 
            subject: "Deployment of Pull Request #${params.PR_NUM} to ${env.DEPLOY_ENV} environment FAILED",
            mimeType: 'text/html',
            from: "zabbix@weigandt-consulting.com",
            body: """<h4 style="font-family:tahoma;color:rgb(247,32,9)">FAILURE</h4/
            <ul style="font-family:tahoma;">
              <li>PR ref:         <b><a href="https://github.com/icanneverwin/webhook_jenkins_test/pull/${params.PR_NUM}">GitHub</a></b>;</li>
              <li>PR name:        <b>${params.PR_TITLE}</b>;</li>
              <li>From branch:    <b>${params.HEAD_BRANCH}</b>;</li>
              <li>To branch:      <b>${params.BASE_BRANCH}</b>;</li>
              <li>By user:        <b>${params.PR_USER}</b>;</li>
              <li>Jenkins build:  <b>${env.BUILD_NUMBER}</b>;</li>
              <li>Hostname:       <b>${env.HOSTNAME}</li>
              <li>IP:       <b>${env.IP_ADDR}</li>
            </ul>
            <p style="font-family:tahoma;">Your friendly neighborhood, Jenkins </p>""",
            to: "${env.email_add1}, ${env.email_add2}"
          )
        }
      }
    }
  }
}
/*
def sendStartEmail() {

}

def sendFinalEmail() {

}
 */
