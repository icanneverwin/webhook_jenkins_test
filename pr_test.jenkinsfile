pipeline {
  agent any
  environment {
    email_add1 = 'ivan.pilyushenko@weigandt-consulting.com'
    email_add2 = 'konstantin.orlov@weigandt-consulting.com'
  }
  stages {
    stage('Check Var') {
      steps {
        echo "========================================"
        echo "variables are as folows:"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.HEAD_BRANCH}"
        echo "BASE_SHA value is ${params.BASE_SHA}"
        echo "HEAD_SHA value is ${params.HEAD_SHA}"
        echo "REVIEW_STATE value is ${params.REVIEW_STATE}"
      }
    }
    stage('DEV Deploy') {
      when {
        allOf {
          expression { params.PR_ACTION ==~ "opened" }
          expression { params.BASE_BRANCH ==~ "develop" }
        }
      }
      steps {
        echo "========================================"
        echo "deployment to DEV is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.HEAD_BRANCH}"
      }
    }
    stage('TEST deploy') {
      when {
        allOf {
          expression { params.BASE_BRANCH ==~ "develop" }
          expression { params.PR_ACTION ==~ "submitted" }
          expression { params.REVIEW_STATE ==~ "approved" }
        }
      }
      steps {
        echo "========================================"
        echo "deployment to TEST is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.EAD_BRANCH}"
        echo "REVIEW_STATE value is ${params.REVIEW_STATE}"
      }
    }
    stage('PROD deploy') {
      when {
        allOf {
          expression { params.PR_ACTION ==~ "submitted" }
          expression { params.BASE_BRANCH ==~ "main" }
          expression { params.HEAD_BRANCH ==~ "develop" }
          expression { params.REVIEW_STATE ==~ "approved" }
        }
      }
      steps {
        echo "========================================"
        echo "deployment to PROD is happening"
        echo "PR_ACTION value is ${params.PR_ACTION}"
        echo "BASE_BRANCH value is ${params.BASE_BRANCH}"
        echo "HEAD_BRANCH value is ${params.HEAD_BRANCH}"
        echo "REVIEW_STATE value is ${params.REVIEW_STATE}"
      }
    }
  }
  post {
      always {
          emailext (
              subject: "Job '${env.JOB_NAME}' build number ['${env.BUILD_NUMBER}'] executed",
              mimeType: 'text/html',
              from: "Your friendly neighborhood Jenkins",
              body: """<p>STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
              <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>""",
              to: "${env.email_add1}, ${env.email_add2}"
          )
      }
  }
}
